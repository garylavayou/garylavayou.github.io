<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Airflow - Learning Programming Book</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="The example book covers examples.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/pagetoc.css">
        <!-- MathJax -->
        <!-- <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> -->
        <script async type="text/javascript" src="theme/MathJax.js"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../prefix.html">Prefix</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">程序设计语言</li><li class="chapter-item expanded "><a href="../Python/Python编程基础.html">Python</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Python/Python编程基础.html">编程基础</a></li><li class="chapter-item expanded "><a href="../Python/Python开发环境.html">开发环境</a></li><li class="chapter-item expanded "><a href="../Python/Python数据类型.html">数据类型</a></li><li class="chapter-item expanded "><a href="../Python/Python输入输出.html">输入输出</a></li><li class="chapter-item expanded "><a href="../Python/Python编程应用.html">编程应用</a></li><li class="chapter-item expanded "><a href="../Python/Python数值计算.html">数值计算</a></li><li class="chapter-item expanded "><a href="../Python/Python系统编程.html">系统编程</a></li><li class="chapter-item expanded "><a href="../Python/Python高级编程.html">高级编程</a></li></ol></li><li class="chapter-item expanded "><a href="../Java/JAVA编程基础.html">Java</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Java/JAVA编程基础.html">编程基础</a></li><li class="chapter-item expanded "><a href="../Java/Java开发环境.html">开发环境</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Java/Maven POM.html">Maven 配置</a></li></ol></li><li class="chapter-item expanded "><a href="../Java/JAVA数据类型.html">数据类型</a></li><li class="chapter-item expanded "><a href="../Java/JAVA输入输出.html">输入输出</a></li><li class="chapter-item expanded "><a href="../Java/JAVA系统编程.html">系统编程</a></li><li class="chapter-item expanded "><a href="../Java/Scala.html">Scala</a></li><li class="chapter-item expanded "><a href="../Java/ScalaFrameworks.html">Scala 框架</a></li></ol></li><li class="chapter-item expanded "><a href="../CSharp.NET/CSharp编程基础.html">C#/.NET</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../CSharp.NET/CSharp编程基础.html">编程基础</a></li><li class="chapter-item expanded "><a href="../CSharp.NET/CSharp输入输出.html">输入输出</a></li><li class="chapter-item expanded "><a href="../CSharp.NET/CSharp数据容器.html">数据容器</a></li><li class="chapter-item expanded "><a href="../CSharp.NET/CSharp数值计算.html">数值计算</a></li><li class="chapter-item expanded "><a href="../CSharp.NET/dotnet开发.html">.NET 开发</a></li></ol></li><li class="chapter-item expanded "><a href="../CC++/Modern C++.html">C and C++</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../CC++/Modern C++.html">Modern C++</a></li><li class="chapter-item expanded "><a href="../CC++/C++开发环境.html">开发环境</a></li><li class="chapter-item expanded "><a href="../CC++/C++容器.html">数据容器</a></li><li class="chapter-item expanded "><a href="../CC++/输入输出.html">输入输出</a></li><li class="chapter-item expanded "><a href="../CC++/标准函数库.html">标准库</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../CC++/数学函数.html">数学函数</a></li></ol></li></ol></li><li class="chapter-item expanded "><div>Web开发</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../JavaScript/JavaScript.html">JavaScript</a></li><li class="chapter-item expanded "><a href="../JavaScript/TypeScript.html">TypeScript</a></li><li class="chapter-item expanded "><a href="../JavaScript/JS开发环境.html">开发环境</a></li></ol></li><li class="chapter-item expanded "><div>开发工具</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../开发环境/git.html">Git</a></li><li class="chapter-item expanded "><a href="../笔记/正则表达式.html">正则表达式</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><li class="part-title">操作系统</li><li class="chapter-item expanded "><a href="../Linux/Linux配置和管理.html">Linux</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Linux/Linux配置和管理.html">配置管理</a></li><li class="chapter-item expanded "><a href="../Linux/Linux-Shell.html">Shell Script</a></li><li class="chapter-item expanded "><a href="../Linux/Linux发行版.html">Linux 发行版</a></li><li class="chapter-item expanded "><a href="../Linux/操作系统原理.html">操作系统原理</a></li></ol></li><li class="chapter-item expanded "><a href="../Windows/Windows配置管理.html">Windows</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Windows/Windows配置管理.html">配置管理</a></li><li class="chapter-item expanded "><a href="../Windows/Windows Shell.html">Shell</a></li><li class="chapter-item expanded "><a href="../Windows/Windows Applications.html">应用软件</a></li></ol></li><li class="chapter-item expanded "><div>应用软件</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../应用软件/程序开发软件.html">程序开发</a></li><li class="chapter-item expanded "><a href="../应用软件/服务器管理软件.html">服务器管理</a></li><li class="chapter-item expanded "><a href="../应用软件/网络访问软件.html">网络访问</a></li><li class="chapter-item expanded "><a href="../应用软件/网络服务软件.html">网络服务</a></li><li class="chapter-item expanded "><a href="../应用软件/文档生成软件.html">文档生成</a></li><li class="chapter-item expanded "><a href="../应用软件/文件处理软件.html">文件处理</a></li><li class="chapter-item expanded "><a href="../应用软件/协作办公软件.html">协作办公</a></li><li class="chapter-item expanded "><a href="../应用软件/知识管理软件.html">知识管理</a></li><li class="chapter-item expanded "><a href="../应用软件/多媒体编辑软件.html">多媒体编辑</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><li class="part-title">机器学习</li><li class="chapter-item expanded "><a href="../机器学习/机器学习实践.html">机器学习实践</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../机器学习/ScikitLearn.html">scikit-learn</a></li><li class="chapter-item expanded "><a href="../机器学习/TensorFlow.html">TensorFlow</a></li><li class="chapter-item expanded "><a href="../机器学习/Pytorch.html">Pytorch</a></li><li class="chapter-item expanded "><a href="../机器学习/图神经网络.html">图神经网络</a></li></ol></li><li class="chapter-item expanded "><a href="../机器学习/机器学习原理与算法.html">原理与算法</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../机器学习/统计学习算法.html">统计学习算法</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><li class="part-title">数据库</li><li class="chapter-item expanded "><a href="../数据库/SQL语法.html">SQL</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../数据库/SQL DDL.html">SQL DDL</a></li><li class="chapter-item expanded "><a href="../数据库/SQL DML.html">SQL DML</a></li><li class="chapter-item expanded "><a href="../数据库/SQL数据类型.html">数据类型</a></li></ol></li><li class="chapter-item expanded "><a href="../数据库/MySQL.html">MySQL</a></li><li class="chapter-item expanded "><a href="../数据库/PostgreSQL.html">PostgreSQL</a></li><li class="chapter-item expanded "><a href="../数据库/HiveSQL.html">Hive SQL</a></li><li class="chapter-item expanded "><a href="../数据库/Elasticsearch.html">Elasticsearch</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../数据库/Elastic Datasource.html">数据源</a></li></ol></li><li class="chapter-item expanded "><a href="../数据库/Mongodb.html">Mongodb</a></li><li class="chapter-item expanded "><a href="../数据库/GraphDatabase.html">图数据库</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">服务和大数据平台</li><li class="chapter-item expanded "><a href="../服务器/分布式大数据处理.html">分布式大数据处理</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../服务器/CDH6大数据集群离线安装.html">CDH6 安装教程</a></li><li class="chapter-item expanded "><a href="../服务器/Spark Python API.html">Pyspark</a></li><li class="chapter-item expanded "><a href="../服务器/流数据处理.html">流数据处理</a></li></ol></li><li class="chapter-item expanded "><a href="../服务器/容器编排.html">容器编排</a></li><li class="chapter-item expanded "><a href="../服务器/虚拟化.html">虚拟化</a></li><li class="chapter-item expanded "><div>任务编排</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../服务器/Airflow.html" class="active">Airflow</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><li class="part-title">其他</li><li class="chapter-item expanded "><div>数据标记语言</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../数据交换语言/JSON and YAML.html">JSON and YAML</a></li><li class="chapter-item expanded "><a href="../数据交换语言/XML.html">XML</a></li><li class="chapter-item expanded "><a href="../数据交换语言/HTML.html">HTML</a></li></ol></li><li class="chapter-item expanded "><div>网络协议</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Protocols/http.html">HTTP</a></li><li class="chapter-item expanded "><a href="../Protocols/DNS.html">DNS</a></li><li class="chapter-item expanded "><a href="../Protocols/端口分配.html">端口分配</a></li><li class="chapter-item expanded "><a href="../Protocols/IP protocol numbers.html">IP 承载协议</a></li><li class="chapter-item expanded "><a href="../Protocols/RPC.html">RPC</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Learning Programming Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <h1 id="airflow"><a class="header" href="#airflow">Airflow</a></h1>
<blockquote>
<p>Airflow is a platform to programmatically author, schedule and monitor workflows.</p>
<p>Use Airflow to author workflows as <strong>Directed Acyclic Graphs (DAGs)</strong> of tasks. The <strong>Airflow scheduler</strong> executes your tasks on an array of workers while following the specified dependencies.</p>
<p>Airflow is used to process data, but has the opinion that tasks should ideally be idempotent (i.e. results of the task will be the same, and will not create duplicated data in a destination system), and should not pass large quantities of data from one task to the next (though tasks can pass metadata using Airflow's <a href="https://airflow.apache.org/docs/apache-airflow/stable/concepts.html#xcoms">Xcom feature</a>). </p>
<p>Airflow is not a streaming solution, but it is often used to process real-time data, pulling data <strong>off streams</strong> in batches.</p>
</blockquote>
<h2 id="安装"><a class="header" href="#安装">安装</a></h2>
<h3 id="单机试用"><a class="header" href="#单机试用">单机试用</a></h3>
<p>试用环境配置：使用SQLite+<code>SequentialExecutor</code><sup class="footnote-reference"><a href="#local-quick">1</a></sup>。</p>
<pre><code class="language-shell">airflow standalone
# airflow db init
# airflow users create \
#     --username admin \
#     --firstname Peter \
#     --lastname Parker \
#     --role Admin \
#     --email spiderman@superhero.org
# airflow webserver --port 8080
# airflow scheduler
</code></pre>
<h3 id="部署airflow"><a class="header" href="#部署airflow">部署Airflow</a></h3>
<h4 id="使用docker部署"><a class="header" href="#使用docker部署">使用Docker部署</a></h4>
<p>从官方获取示例<code>docker-compose.yaml</code>文件<sup class="footnote-reference"><a href="#docker-quick">2</a></sup>，并根据生产环境进行定制。</p>
<pre><code class="language-shell">VERSION=&quot;2.2.5&quot;
curl -LfO &quot;https://airflow.apache.org/docs/apache-airflow/$VERSION/docker-compose.yaml&quot;
</code></pre>
<ul>
<li><code>airflow-scheduler</code> - The <a href="https://airflow.apache.org/docs/apache-airflow/stable/concepts/scheduler.html">scheduler</a> monitors all tasks and DAGs, then triggers the task instances once their dependencies are complete.</li>
<li><code>airflow-webserver</code> - The webserver is available at <code>http://localhost:8080</code>.</li>
<li><code>airflow-worker</code> - The worker that executes the tasks given by the scheduler.</li>
<li><code>airflow-init</code> - The initialization service（执行后正常退出）.</li>
<li><code>flower</code> - <a href="https://flower.readthedocs.io/en/latest/">The flower app</a> for monitoring the environment. It is available at <code>http://localhost:5555</code>.</li>
<li><code>postgres</code> - The database.</li>
<li><code>redis</code> - <a href="https://redis.io/">The redis</a> - broker that forwards messages from scheduler to worker.</li>
</ul>
<p>在<code>.env</code>文件设置要使用的Airflow版本（默认为<code>docker-compose.yaml</code>文件中指定的默认版本）以及用户名和密码。</p>
<pre><code class="language-shell">COMPOSE_PROJECT_NAME=airflow2
# AIRFLOW_IMAGE_NAME=&quot;apache/airflow:2.2.5&quot;
_AIRFLOW_WWW_USER_USERNAME=&quot;gary&quot;
_AIRFLOW_WWW_USER_PASSWORD=&quot;gang2019&quot;
AIRFLOW_UID=50000  # run service as the user with UID inside the containers
</code></pre>
<blockquote>
<p>如果需要映射主机目录到容器，则设置<code>AIRFLOW_UID=$(id -u)</code>，防止在相关数据目录下以<code>root</code>账户创建文件。如果使用数据卷则使用默认值即可。</p>
</blockquote>
<p>此外，配置额外插件及插件的配置参数，插件将在初始化阶段安装。不推荐在生产环境中使用这种方式安装插件，而是应该<a href="https://airflow.apache.org/docs/docker-stack/build.html">构建自定义Docker镜像</a>。</p>
<pre><code class="language-shell">_PIP_ADDITIONAL_REQUIREMENTS=&quot;airflow-code-editor black&quot;
AIRFLOW__CODE_EDITOR__ROOT_DIRECTORY=&quot;/opt/airflow/dags&quot;
AIRFLOW__CODE_EDITOR__LINE_LENGTH=90
AIRFLOW__CODE_EDITOR__STRING_NORMALIZATION=False
AIRFLOW__CODE_EDITOR__GIT_ENABLED=False
</code></pre>
<p>执行数据库初始化并创建首个用户（初始化成功返回状态为<code>0</code>）。</p>
<pre><code class="language-shell">docker-compose up airflow-init
docker-compose down --volumes --remove-orphans  # 如果出现错误，清理环境，检查配置文件重新执行初始化
</code></pre>
<p>启动Airflow服务集群（<code>docker-compose up -d</code>）并检查服务状态（<code>docker-compose ps</code>）。</p>
<h5 id="数据存储"><a class="header" href="#数据存储">数据存储</a></h5>
<p>在上述集群配置文件中，所有相关服务共享同一个Airflow的工作目录（包括<code>dags</code>，<code>logs</code>和<code>plugins</code>）。</p>
<h5 id="自定义镜像"><a class="header" href="#自定义镜像">自定义镜像</a></h5>
<p>https://airflow.apache.org/docs/docker-stack/build.html</p>
<h4 id="安装插件"><a class="header" href="#安装插件">安装插件</a></h4>
<p>插件以Python模块的形式提供。</p>
<ul>
<li>Docker：在<code>_PIP_ADDITIONAL_REQUIREMENTS</code>中指定附加插件，或构建自定义镜像时安装插件。</li>
</ul>
<h4 id="安装providers"><a class="header" href="#安装providers">安装Providers</a></h4>
<p>http://airflow.apache.org/docs/apache-airflow-providers/index.html</p>
<h4 id="eco-system"><a class="header" href="#eco-system">eco-system</a></h4>
<p><a href="https://github.com/andreax79/airflow-code-editor">andreax79/airflow-code-editor: A plugin for Apache Airflow that allows you to edit DAGs in browser (github.com)</a></p>
<p><a href="http://airflow.apache.org/ecosystem/">Ecosystem | Apache Airflow</a></p>
<p><a href="https://elyra.readthedocs.io/en/stable/">Elyra Documentation — Elyra 3.2.2 documentation</a></p>
<p><a href="https://stackoverflow.com/questions/48986732/airflow-creating-a-dag-in-airflow-via-ui">Airflow: Creating a DAG in airflow via UI - Stack Overflow</a></p>
<h3 id="配置"><a class="header" href="#配置">配置</a></h3>
<pre><code class="language-shell">export AIRFLOW_HOME=/opt/airflow/  # 默认工作目录: 包含dags，logs等子目录
</code></pre>
<p><code>$AIRFLOW_HOME/airflow.cfg</code>：配置文件。</p>
<h2 id="概念"><a class="header" href="#概念">概念</a></h2>
<h5 id="dag"><a class="header" href="#dag">DAG</a></h5>
<p>作业设计说明（有向无环图）。有一个或多个任务构成。</p>
<pre><code class="language-shell">airflow dags list
airflow dags list-jobs   # 列出作业
airflow dags list-runs
airflow dags test dag_id run_date
</code></pre>
<blockquote>
<p>默认路径位于<code>$AIRFLOW_HOME/dags</code>，在该目录下创建的作业会被airflow扫描并自动加载（有一定的时延）。</p>
</blockquote>
<h5 id="task"><a class="header" href="#task">task</a></h5>
<p>[Tasks — Airflow Documentation (apache.org)](https://airflow.apache.org/docs/apache-airflow/stable/concepts/tasks.html?highlight=create task)</p>
<p>任务。</p>
<pre><code class="language-shell">airflow run dag_id task_id date
</code></pre>
<h5 id="jobs"><a class="header" href="#jobs">jobs</a></h5>
<p>正在运行的作业。</p>
<pre><code class="language-shell">airflow jobs check
</code></pre>
<h2 id="使用airflow"><a class="header" href="#使用airflow">使用Airflow</a></h2>
<h3 id="cli"><a class="header" href="#cli">CLI</a></h3>
<p>进入任意服务节点的终端，执行<code>airflow info</code>可查看Airflow的配置以及系统环境信息。</p>
<pre><code class="language-shell">airflow [-h] GROUP_OR_COMMAND ...

positional arguments:
  GROUP_OR_COMMAND

    Groups:
      celery         Celery components
      config         View configuration
      connections    Manage connections
      dags           Manage DAGs
      db             Database operations
      jobs           Manage jobs
      kubernetes     Tools to help run the KubernetesExecutor
      pools          Manage pools
      providers      Display providers
      roles          Manage roles
      tasks          Manage tasks
      users          Manage users
      variables      Manage variables

    Commands:
      cheat-sheet    Display cheat sheet
      info           Show information about current Airflow and environment
      kerberos       Start a kerberos ticket renewer
      plugins        Dump information about loaded plugins
      rotate-fernet-key
                     Rotate encrypted connection credentials and variables
      scheduler      Start a scheduler instance
      standalone     Run an all-in-one copy of Airflow
      sync-perm      Update permissions for existing roles and optionally DAGs
      triggerer      Start a triggerer instance
      version        Show the version
      webserver      Start a Airflow webserver instance
</code></pre>
<pre><code class="language-shell">usage: airflow dags [-h] COMMAND ...

Manage DAGs

positional arguments:
  COMMAND
    backfill      Run subsections of a DAG for a specified date range
    delete        Delete all DB records related to the specified DAG
    list          List all the DAGs
    list-jobs     List the jobs
    list-runs     List DAG runs given a DAG id
    next-execution
                  Get the next execution datetimes of a DAG
    pause         Pause a DAG
    report        Show DagBag loading report
    show          Displays DAG's tasks with their dependencies
    state         Get the status of a dag run
    test          Execute one single DagRun
    trigger       Trigger a DAG run
    unpause       Resume a paused DAG
</code></pre>
<h4 id="dags"><a class="header" href="#dags">dags</a></h4>
<h4 id="tasks"><a class="header" href="#tasks">tasks</a></h4>
<pre><code class="language-shell">airflow tasks test $DAG_ID $TASK_ID $DATE # 执行任务
</code></pre>
<h3 id="使用web界面"><a class="header" href="#使用web界面">使用Web界面</a></h3>
<p>访问<code>airflow-web</code>服务开启的HTTP端口（默认为http://localhost:8080，默认用户名和密码为预先使用环境变量配置的）。</p>
<h3 id="使用rest接口"><a class="header" href="#使用rest接口">使用REST接口</a></h3>
<p>使用REST API访问Web服务。</p>
<pre><code class="language-shell">ENDPOINT_URL=&quot;http://localhost:8080/&quot;
curl -X GET --user &quot;USER:PASSWD&quot; &quot;${ENDPOINT_URL}/api/v1/pools&quot;
</code></pre>
<p>Airflow提供了封装的Python API客户端访问Web服务（<a href="https://github.com/apache/airflow-client-python">apache/airflow-client-python: Apache Airflow - OpenApi Client for Python (github.com)</a>）</p>
<h2 id="任务编排"><a class="header" href="#任务编排">任务编排</a></h2>
<p>为任务添加标签方便查询相关任务。</p>
<pre><code class="language-python">with DAG(dag_id=&quot;first_airflow_dag&quot;, 
          schedule_interval='* * * * *', # crontab语法或@once/hourly/daily/weekly/monthly/yearly
          start_date=datetime(year=2022, month=2, day=1),
          tags = [&quot;team1&quot;, &quot;sql&quot;]) as dag:
  task_get_datetime = BashOperator(
    task_id='get_datetime',
    bash_command='date'
  )
  task_get_datetime &gt;&gt; task_process_datetime &gt;&gt; task_save_datetime
</code></pre>
<p>任务保存在工作目录的<code>dags/</code>目录下，可从Web界面访问并<strong>执行/暂停</strong>任务（可在DAG列表或DAG页面执行）。</p>
<p><img src="Airflow.assets/image-20220406112048869.png" alt="image-20220406112048869" /></p>
<p>任务执行的返回值由Airflow内部保存，可通过<code>xcoms</code>接口获取。</p>
<p>使用<code>&gt;&gt;</code>或<code>set_downstream()</code>连接任务，保证任务按正确顺序执行。</p>
<img src="Airflow.assets/image-20220406111545204.png" alt="任务执行流程" style="zoom:50%;" />
<p><img src="Airflow.assets/image-20220406111639213.png" alt="任务树和对应的执行状态" /></p>
<p>Airflow将动态检测任务编排文件，并应用最新的任务调度配置。</p>
<p><a href="https://airflow.apache.org/docs/apache-airflow/stable/tutorial.html">Tutorial — Airflow Documentation (apache.org)</a></p>
<p><a href="http://airflow.apache.org/docs/apache-airflow/stable/howto/index.html">How-to Guides</a> </p>
<p><a href="https://airflow.apache.org/docs/apache-airflow/stable/best-practices.html">Best Practices — Airflow Documentation (apache.org)</a></p>
<h3 id="内置任务模块"><a class="header" href="#内置任务模块">内置任务模块</a></h3>
<p><code>BashOperator(task_id, bash_command)</code></p>
<p><code>PythonOperator(task_id, python_callable=pyfunc)</code></p>
<h3 id="系统内置变量"><a class="header" href="#系统内置变量">系统内置变量</a></h3>
<p>访问Airflow网页，进入<code>Admin-Variables</code>创建变量（<code>Key-Value-Description</code>）。变量可在任务编排代码中引用。</p>
<pre><code class="language-python">var_name = Variable.get('var_name')
</code></pre>
<h2 id="问题"><a class="header" href="#问题">问题</a></h2>
<p><a href="https://stackoverflow.com/questions/45534535/airflow-not-loading-dags-in-usr-local-airflow-dags">Airflow not loading dags in /usr/local/airflow/dags - Stack Overflow</a></p>
<p><a href="https://stackoverflow.com/questions/38992997/dag-not-visible-in-web-ui">python - DAG not visible in Web-UI - Stack Overflow</a></p>
<h2 id="任务编排工具对比"><a class="header" href="#任务编排工具对比">任务编排工具对比</a></h2>
<p>最好的任务编排工具：Airflow vs Luigi vs Argo vs MLFlow - 数据黑客的文章 - 知乎 https://zhuanlan.zhihu.com/p/321231718</p>
<p><a href="https://luigi.readthedocs.io/en/stable/index.html">Getting Started — Luigi 2.8.13 documentation</a></p>
<h2 id="参考文献"><a class="header" href="#参考文献">参考文献</a></h2>
<div class="footnote-definition" id="install-list"><sup class="footnote-definition-label">3</sup>
<p><a href="https://airflow.apache.org/docs/apache-airflow/stable/installation/index.html">Installation — Airflow Documentation (apache.org)</a>
<sup class="footnote-reference"><a href="#local-quick">1</a></sup>: <a href="https://airflow.apache.org/docs/apache-airflow/stable/start/local.html#running-airflow-locally">Running Airflow locally — Airflow Documentation (apache.org)</a>
<sup class="footnote-reference"><a href="#docker-quick">2</a></sup>: <a href="https://airflow.apache.org/docs/apache-airflow/stable/start/docker.html">Running Airflow in Docker — Airflow Documentation (apache.org)</a></p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../服务器/虚拟化.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../数据交换语言/JSON and YAML.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../服务器/虚拟化.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../数据交换语言/JSON and YAML.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../theme/pagetoc.js"></script>
        <script type="text/javascript" src="../theme/MathJax.js"></script>
    </body>
</html>